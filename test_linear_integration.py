#!/usr/bin/env python3
"""Test script to verify Linear integration setup."""

import os
import sys
from pathlib import Path

# Add the project root to Python path
sys.path.insert(0, str(Path(__file__).parent))

from rca.linear_client import load_linear_config, create_linear_ticket
from rca.schema import TicketData


def test_configuration():
    """Test Linear configuration."""
    print("ğŸ” Testing Linear Configuration...")
    
    config = load_linear_config()
    
    print(f"ğŸ“‹ API Key: {'âœ… SET' if config['api_key'] else 'âŒ NOT SET'}")
    print(f"ğŸ“‹ Team Key: {config['team_key']}")
    
    if config['api_key']:
        print(f"ğŸ”‘ API Key starts with: {config['api_key'][:10]}...")
        return True
    else:
        print("âš ï¸  No API key found - will create mock tickets")
        return False


def test_ticket_creation():
    """Test creating a Linear ticket."""
    print("\nğŸ« Testing Ticket Creation...")
    
    # Create test ticket data
    ticket_data = TicketData(
        title="[TEST] RCA Agent Integration Test",
        description="""## Test Ticket

This is a test ticket created by the RCA Agent to verify Linear integration.

### Test Details
- **Purpose:** Verify Linear API integration
- **Created by:** RCA Agent test script
- **Status:** This is a test - can be deleted

### Next Steps
- [ ] Verify ticket appears in Linear workspace
- [ ] Check ticket has correct team assignment
- [ ] Confirm description formatting is correct
- [ ] Delete this test ticket

_This ticket was auto-generated by RCA Agent test script_""",
        team_key="FTS",  # Default team key
        priority=2,  # Medium priority
        labels=["test", "rca-agent", "integration"],
        assignee=None
    )
    
    # Create the ticket
    result = create_linear_ticket(ticket_data)
    
    # Display results
    if result['success']:
        print(f"âœ… Ticket created successfully!")
        print(f"ğŸ“‹ Ticket ID: {result['ticket_id']}")
        print(f"ğŸ”— Ticket URL: {result['ticket_url']}")
        print(f"ğŸ“ Type: {result['type']}")
        
        if result['type'] == 'mock':
            print(f"ğŸ“„ Mock file: {result.get('file_path', 'N/A')}")
            print("ğŸ’¡ To create real tickets, add your LINEAR_API_KEY to .env file")
        else:
            print("ğŸ‰ Real Linear ticket created! Check your Linear workspace.")
            
    else:
        print(f"âŒ Failed to create ticket: {result['error']}")
        return False
    
    return True


def main():
    """Main test function."""
    print("ğŸš€ RCA Agent Linear Integration Test\n")
    
    # Test 1: Configuration
    has_api_key = test_configuration()
    
    # Test 2: Ticket Creation
    success = test_ticket_creation()
    
    # Summary
    print("\n" + "="*50)
    print("ğŸ“Š Test Summary:")
    print(f"ğŸ”§ Configuration: {'âœ… PASS' if True else 'âŒ FAIL'}")
    print(f"ğŸ« Ticket Creation: {'âœ… PASS' if success else 'âŒ FAIL'}")
    
    if has_api_key and success:
        print("\nğŸ‰ All tests passed! Linear integration is working correctly.")
        print("ğŸ’¡ You can now create real Linear tickets with the RCA Agent.")
    elif success:
        print("\nâš ï¸  Tests passed in mock mode.")
        print("ğŸ’¡ Add your LINEAR_API_KEY to .env to create real tickets.")
    else:
        print("\nâŒ Some tests failed. Check the error messages above.")
        return 1
    
    print("\nğŸ“š Next steps:")
    print("1. Run: python -m rca.cli ticket incidents/TCK-1001.json --team YOUR_TEAM")
    print("2. Check your Linear workspace for the ticket")
    print("3. Verify the ticket content and formatting")
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
